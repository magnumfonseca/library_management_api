---
openapi: 3.0.1
info:
  title: Library Management API
  version: v1
  description: Comprehensive REST API for managing a library system with user authentication,
    book management, and borrowing features
  contact:
    name: Library Management Team
paths:
  "/api/v1/books":
    get:
      summary: List all books
      tags:
      - Books
      description: Retrieve a paginated list of all books in the library. Available
        to all authenticated users.
      security:
      - bearer_jwt: []
      parameters:
      - name: Authorization
        in: header
        required: true
        description: JWT Bearer token
        schema:
          type: string
      - name: page
        in: query
        required: false
        description: 'Page number (default: 1)'
        schema:
          type: integer
      - name: per_page
        in: query
        required: false
        description: 'Number of items per page (default: 25, max: 100)'
        schema:
          type: integer
      - name: page[number]
        in: query
        required: false
        description: Page number (JSON:API style)
        schema:
          type: integer
      - name: page[size]
        in: query
        required: false
        description: Page size (JSON:API style)
        schema:
          type: integer
      responses:
        '200':
          description: Caps per_page at maximum
          content:
            application/vnd.api+json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        type:
                          type: string
                          example: books
                        attributes:
                          type: object
                          properties:
                            title:
                              type: string
                            author:
                              type: string
                            genre:
                              type: string
                            isbn:
                              type: string
                            total_copies:
                              type: integer
                            available_copies:
                              type: integer
                  meta:
                    type: object
                    properties:
                      page:
                        type: object
                        properties:
                          total:
                            type: integer
                            description: Total number of records
                          totalPages:
                            type: integer
                            description: Total number of pages
                          number:
                            type: integer
                            description: Current page number
                          size:
                            type: integer
                            description: Number of records per page
                  links:
                    type: object
                    properties:
                      self:
                        type: string
                      first:
                        type: string
                      last:
                        type: string
                      prev:
                        type: string
                        nullable: true
                      next:
                        type: string
                        nullable: true
        '401':
          description: Unauthorized - Missing or invalid token
    post:
      summary: Create a new book
      tags:
      - Books
      description: Create a new book in the library. Only librarians can create books.
      security:
      - bearer_jwt: []
      parameters:
      - name: Authorization
        in: header
        required: true
        description: JWT Bearer token
        schema:
          type: string
      responses:
        '201':
          description: Creates a new book record
          content:
            application/vnd.api+json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      type:
                        type: string
                        example: books
                      attributes:
                        type: object
                        properties:
                          title:
                            type: string
                          author:
                            type: string
                          genre:
                            type: string
                          isbn:
                            type: string
                          total_copies:
                            type: integer
                          available_copies:
                            type: integer
                  meta:
                    type: object
                    properties:
                      message:
                        type: string
        '403':
          description: Forbidden - Only librarians can create books
        '422':
          description: Validation error - Invalid total_copies
        '401':
          description: Unauthorized
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                book:
                  type: object
                  properties:
                    title:
                      type: string
                      description: Book title
                    author:
                      type: string
                      description: Author name
                    genre:
                      type: string
                      description: Book genre
                    isbn:
                      type: string
                      description: ISBN-10 or ISBN-13
                    total_copies:
                      type: integer
                      description: Total number of copies
                  required:
                  - title
                  - author
                  - total_copies
              required:
              - book
  "/api/v1/books/{id}":
    parameters:
    - name: id
      in: path
      required: true
      description: Book ID
      schema:
        type: string
    get:
      summary: Get book details
      tags:
      - Books
      description: Retrieve detailed information about a specific book. Available
        to all authenticated users.
      security:
      - bearer_jwt: []
      parameters:
      - name: Authorization
        in: header
        required: true
        description: JWT Bearer token
        schema:
          type: string
      responses:
        '200':
          description: Returns available_copies correctly with borrowings
          content:
            application/vnd.api+json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      type:
                        type: string
                        example: books
                      attributes:
                        type: object
                        properties:
                          title:
                            type: string
                          author:
                            type: string
                          genre:
                            type: string
                          isbn:
                            type: string
                          total_copies:
                            type: integer
                          available_copies:
                            type: integer
                  meta:
                    type: object
        '404':
          description: Book not found
        '401':
          description: Unauthorized
    patch:
      summary: Update book
      tags:
      - Books
      description: Update book information. Only librarians can update books.
      security:
      - bearer_jwt: []
      parameters:
      - name: Authorization
        in: header
        required: true
        description: JWT Bearer token
        schema:
          type: string
      responses:
        '200':
          description: Updates multiple attributes
          content:
            application/vnd.api+json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      type:
                        type: string
                        example: books
                      attributes:
                        type: object
                        properties:
                          title:
                            type: string
                          author:
                            type: string
                          genre:
                            type: string
                          isbn:
                            type: string
                          total_copies:
                            type: integer
                          available_copies:
                            type: integer
                  meta:
                    type: object
                    properties:
                      message:
                        type: string
        '403':
          description: Forbidden - Only librarians can update books
        '422':
          description: Validation error - Duplicate ISBN
        '404':
          description: Book not found
        '401':
          description: Unauthorized
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                book:
                  type: object
                  properties:
                    title:
                      type: string
                    author:
                      type: string
                    genre:
                      type: string
                    isbn:
                      type: string
                    total_copies:
                      type: integer
    delete:
      summary: Delete book
      tags:
      - Books
      description: Delete a book from the library. Only librarians can delete books.
        Books with active borrowings cannot be deleted.
      security:
      - bearer_jwt: []
      parameters:
      - name: Authorization
        in: header
        required: true
        description: JWT Bearer token
        schema:
          type: string
      responses:
        '204':
          description: Deletes book with only returned borrowings
        '403':
          description: Forbidden - Only librarians can delete books
        '422':
          description: Unprocessable entity - Book has active borrowings
        '404':
          description: Book not found
        '401':
          description: Unauthorized
  "/api/v1/borrowings":
    get:
      summary: List borrowings
      tags:
      - Borrowings
      description: Retrieve a list of borrowings. Librarians see all borrowings, members
        see only their own.
      security:
      - bearer_jwt: []
      parameters:
      - name: Authorization
        in: header
        required: true
        description: JWT Bearer token
        schema:
          type: string
      - name: page
        in: query
        required: false
        description: 'Page number (default: 1)'
        schema:
          type: integer
      - name: per_page
        in: query
        required: false
        description: 'Number of items per page (default: 25, max: 100)'
        schema:
          type: integer
      - name: page[number]
        in: query
        required: false
        description: Page number (JSON:API style)
        schema:
          type: integer
      - name: page[size]
        in: query
        required: false
        description: Page size (JSON:API style)
        schema:
          type: integer
      responses:
        '200':
          description: Pagination with JSON:API style params
          content:
            application/vnd.api+json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        type:
                          type: string
                          example: borrowings
                        attributes:
                          type: object
                          properties:
                            borrowed_at:
                              type: string
                              format: date-time
                            due_date:
                              type: string
                              format: date-time
                            returned_at:
                              type: string
                              format: date-time
                              nullable: true
                            status:
                              type: string
                              enum:
                              - active
                              - overdue
                              - returned
                            days_overdue:
                              type: integer
                            book_id:
                              type: integer
                            user_id:
                              type: integer
                            book_title:
                              type: string
                  meta:
                    type: object
                    properties:
                      page:
                        type: object
                        properties:
                          total:
                            type: integer
                            description: Total number of records
                          totalPages:
                            type: integer
                            description: Total number of pages
                          number:
                            type: integer
                            description: Current page number
                          size:
                            type: integer
                            description: Number of records per page
                  links:
                    type: object
                    properties:
                      self:
                        type: string
                      first:
                        type: string
                      last:
                        type: string
                      prev:
                        type: string
                        nullable: true
                      next:
                        type: string
                        nullable: true
        '401':
          description: Unauthorized - Missing or invalid token
    post:
      summary: Borrow a book
      tags:
      - Borrowings
      description: Create a new borrowing. Only members can borrow books. The book
        must be available.
      security:
      - bearer_jwt: []
      parameters:
      - name: Authorization
        in: header
        required: true
        description: JWT Bearer token
        schema:
          type: string
      responses:
        '201':
          description: Creates a new borrowing record with correct due date
          content:
            application/vnd.api+json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      type:
                        type: string
                        example: borrowings
                      attributes:
                        type: object
                        properties:
                          borrowed_at:
                            type: string
                            format: date-time
                          due_date:
                            type: string
                            format: date-time
                          returned_at:
                            type: string
                            format: date-time
                            nullable: true
                          status:
                            type: string
                          days_overdue:
                            type: integer
                          book_id:
                            type: integer
                          user_id:
                            type: integer
                          book_title:
                            type: string
                  meta:
                    type: object
                    properties:
                      message:
                        type: string
        '403':
          description: Forbidden - Librarians cannot borrow books
        '422':
          description: Validation error - Member already has active borrowing for
            this book
        '404':
          description: Book not found
        '401':
          description: Unauthorized
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                borrowing:
                  type: object
                  properties:
                    book_id:
                      type: integer
                      description: ID of the book to borrow
                  required:
                  - book_id
              required:
              - borrowing
  "/api/v1/borrowings/{id}":
    parameters:
    - name: id
      in: path
      required: true
      description: Borrowing ID
      schema:
        type: string
    get:
      summary: Get borrowing details
      tags:
      - Borrowings
      description: Retrieve detailed information about a specific borrowing. Members
        can only view their own borrowings.
      security:
      - bearer_jwt: []
      parameters:
      - name: Authorization
        in: header
        required: true
        description: JWT Bearer token
        schema:
          type: string
      responses:
        '200':
          description: Librarian can view any borrowing
          content:
            application/vnd.api+json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      type:
                        type: string
                        example: borrowings
                      attributes:
                        type: object
                        properties:
                          borrowed_at:
                            type: string
                            format: date-time
                          due_date:
                            type: string
                            format: date-time
                          returned_at:
                            type: string
                            format: date-time
                            nullable: true
                          status:
                            type: string
                          days_overdue:
                            type: integer
                          book_id:
                            type: integer
                          user_id:
                            type: integer
                          book_title:
                            type: string
                  meta:
                    type: object
        '403':
          description: Forbidden - Member cannot view another user's borrowing
        '404':
          description: Borrowing not found
        '401':
          description: Unauthorized
  "/api/v1/borrowings/{id}/return":
    parameters:
    - name: id
      in: path
      required: true
      description: Borrowing ID
      schema:
        type: string
    patch:
      summary: Return a borrowed book
      tags:
      - Borrowings
      description: Mark a borrowing as returned. Only librarians can perform this
        action.
      security:
      - bearer_jwt: []
      parameters:
      - name: Authorization
        in: header
        required: true
        description: JWT Bearer token
        schema:
          type: string
      responses:
        '200':
          description: Marks borrowing as returned in database
          content:
            application/vnd.api+json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      type:
                        type: string
                        example: borrowings
                      attributes:
                        type: object
                        properties:
                          borrowed_at:
                            type: string
                            format: date-time
                          due_date:
                            type: string
                            format: date-time
                          returned_at:
                            type: string
                            format: date-time
                          status:
                            type: string
                            example: returned
                          days_overdue:
                            type: integer
                          book_id:
                            type: integer
                          user_id:
                            type: integer
                          book_title:
                            type: string
                  meta:
                    type: object
                    properties:
                      message:
                        type: string
        '403':
          description: Forbidden - Members cannot return books
        '422':
          description: Unprocessable entity - Book already returned
        '404':
          description: Borrowing not found
        '401':
          description: Unauthorized
  "/api/v1/invitations":
    get:
      summary: List all invitations
      tags:
      - Invitations
      description: Retrieve a paginated list of all invitations. Only available to
        librarians.
      security:
      - bearer_jwt: []
      parameters:
      - name: Authorization
        in: header
        required: true
        description: JWT Bearer token
        schema:
          type: string
      - name: page
        in: query
        required: false
        description: 'Page number (default: 1)'
        schema:
          type: integer
      - name: per_page
        in: query
        required: false
        description: 'Number of items per page (default: 25, max: 100)'
        schema:
          type: integer
      - name: page[number]
        in: query
        required: false
        description: Page number (JSON:API style)
        schema:
          type: integer
      - name: page[size]
        in: query
        required: false
        description: Page size (JSON:API style)
        schema:
          type: integer
      responses:
        '200':
          description: Orders invitations by created_at desc
          content:
            application/vnd.api+json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        type:
                          type: string
                          example: invitations
                        attributes:
                          type: object
                          properties:
                            email:
                              type: string
                            role:
                              type: string
                            expires_at:
                              type: string
                              format: date-time
                            accepted_at:
                              type: string
                              format: date-time
                              nullable: true
                            status:
                              type: string
                              enum:
                              - pending
                              - accepted
                              - expired
                            created_at:
                              type: string
                              format: date-time
                        relationships:
                          type: object
                          properties:
                            invited_by:
                              type: object
                              properties:
                                data:
                                  type: object
                                  properties:
                                    id:
                                      type: string
                                    type:
                                      type: string
                                      example: users
                  meta:
                    type: object
                    properties:
                      page:
                        type: object
                        properties:
                          total:
                            type: integer
                          totalPages:
                            type: integer
                          number:
                            type: integer
                          size:
                            type: integer
                  links:
                    type: object
                    properties:
                      self:
                        type: string
                      first:
                        type: string
                      last:
                        type: string
                      prev:
                        type: string
                        nullable: true
                      next:
                        type: string
                        nullable: true
        '403':
          description: Member cannot list invitations
        '401':
          description: Requires authentication
    post:
      summary: Create invitation
      tags:
      - Invitations
      description: Create a new invitation to invite a librarian to join the system.
      security:
      - bearer_jwt: []
      parameters:
      - name: Authorization
        in: header
        required: true
        description: JWT Bearer token
        schema:
          type: string
      responses:
        '201':
          description: Invitation created successfully
        '403':
          description: Member cannot create invitations
        '422':
          description: Invalid email format
        '400':
          description: Email is required
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                invitation:
                  type: object
                  properties:
                    email:
                      type: string
                      format: email
                  required:
                  - email
              required:
              - invitation
  "/api/v1/invitations/{id}":
    parameters:
    - name: id
      in: path
      description: Invitation ID
      required: true
      schema:
        type: integer
    get:
      summary: Show invitation
      tags:
      - Invitations
      description: Retrieve details of a specific invitation. Only available to librarians.
      security:
      - bearer_jwt: []
      parameters:
      - name: Authorization
        in: header
        required: true
        description: JWT Bearer token
        schema:
          type: string
      responses:
        '200':
          description: Invitation retrieved successfully
          content:
            application/vnd.api+json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      type:
                        type: string
                        example: invitations
                      attributes:
                        type: object
                        properties:
                          email:
                            type: string
                          role:
                            type: string
                          expires_at:
                            type: string
                            format: date-time
                          accepted_at:
                            type: string
                            format: date-time
                            nullable: true
                          status:
                            type: string
                          created_at:
                            type: string
                            format: date-time
                      relationships:
                        type: object
                  meta:
                    type: object
        '403':
          description: Member cannot view invitations
        '404':
          description: Invitation not found
    delete:
      summary: Delete invitation
      tags:
      - Invitations
      description: Cancel a pending invitation. Only available to librarians. Cannot
        delete accepted or expired invitations.
      security:
      - bearer_jwt: []
      parameters:
      - name: Authorization
        in: header
        required: true
        description: JWT Bearer token
        schema:
          type: string
      responses:
        '204':
          description: Invitation deleted successfully
        '403':
          description: Cannot delete expired invitation (policy check)
        '404':
          description: Invitation not found
  "/api/v1/invitations/token/{token}":
    parameters:
    - name: token
      in: path
      description: Invitation token
      required: true
      schema:
        type: string
    get:
      summary: Show invitation by token
      tags:
      - Invitations
      description: Retrieve invitation details using a token. No authentication required.
        Public endpoint for invitation recipients.
      responses:
        '200':
          description: Invitation retrieved successfully
          content:
            application/vnd.api+json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      type:
                        type: string
                        example: invitations
                      attributes:
                        type: object
                        properties:
                          email:
                            type: string
                          role:
                            type: string
                          expires_at:
                            type: string
                            format: date-time
                          accepted_at:
                            type: string
                            format: date-time
                            nullable: true
                          status:
                            type: string
                      relationships:
                        type: object
                  meta:
                    type: object
        '404':
          description: Invalid token
  "/api/v1/invitations/token/{token}/accept":
    parameters:
    - name: token
      in: path
      description: Invitation token
      required: true
      schema:
        type: string
    patch:
      summary: Accept invitation
      tags:
      - Invitations
      description: Accept an invitation and create a new user account. No authentication
        required.
      parameters: []
      responses:
        '201':
          description: Account created successfully
        '410':
          description: Invitation already accepted
        '422':
          description: Invalid user data
        '404':
          description: Invalid token
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                user:
                  type: object
                  properties:
                    name:
                      type: string
                    password:
                      type: string
                      format: password
                    password_confirmation:
                      type: string
                      format: password
                  required:
                  - name
                  - password
                  - password_confirmation
              required:
              - user
servers:
- url: http://localhost:3000
  description: Development server
- url: https://{host}
  description: Production server
  variables:
    host:
      default: api.example.com
components:
  securitySchemes:
    bearer_jwt:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT authentication token
